#!/bin/bash

# Add this udev rule to autoconfigure keyboard when attached
# ACTION=="add", SUBSYSTEM=="input", ATTRS{idVendor}=="04b4", ATTRS{idProduct}=="0101", SYMLINK+="usb-keyboard", RUN+="/home/pez/.dotfiles/bin/keyboard-setup standard"
# ACTION=="add", SUBSYSTEM=="input", ATTRS{name}=="Keychron K2", SYMLINK+="keychron-k2", RUN+="/home/pez/.dotfiles/bin/keyboard-setup k2"

is_k2_connected() {
  test -e /dev/keychron-k2
}

hack_k2_mapping() {
  xmodmap -e "keycode 112 = Home"
  xmodmap -e "keycode 117 = Prior"
  xmodmap -e "keycode 110 = Next"
  xmodmap -e "keycode 115 = End"

  if [ "${USER}" == "root" ]; then
    echo 0 > /sys/module/hid_apple/parameters/fnmode
  fi
}

reset_mapping() {
  xmodmap -e "keycode 112 = Prior"
  xmodmap -e "keycode 117 = Next"
  xmodmap -e "keycode 110 = Home"
  xmodmap -e "keycode 115 = End"
}

layout_us() {
  /usr/bin/setxkbmap -variant us -option ''
}

layout_us_italian_caps_ctrl() {
  # Keyboard: italian with us layout, CapsLock like Ctrl
  /usr/bin/setxkbmap -layout it -variant us -option 'caps:ctrl_modifier'
}

ctrl_escape() {
  # Caps Lock mapped to: Esc + Ctrl (long press)
  kill $( pgrep xcape ) 2>/dev/null
  if [ "${1}" != "no" ]; then
    /usr/bin/xcape -e 'Caps_Lock=Escape;Control_L=Escape;Control_R=Escape'
  fi
}

fix_repeat_speed() {
  # rate <delay> <speed>
  /usr/bin/xset r rate 250 30
}

detect_mode() {
  if is_k2_connected; then echo 'k2'; return; fi;
    echo 'standard'; return
  }

reset_mode() {
  layout_us
  ctrl_escape no
  reset_mapping
  fix_repeat_speed
}

standard_mode() {
  layout_us_italian_caps_ctrl
  ctrl_escape
  reset_mapping
  fix_repeat_speed
}

k2_mode() {
  layout_us_italian_caps_ctrl
  ctrl_escape
  hack_k2_mapping
  fix_repeat_speed
}

set_mode() {
  mode=$1
  case $1 in
    '') set_mode $( detect_mode );;
    auto) set_mode $( detect_mode );;
    reset) reset_mode;;
    standard) standard_mode;;
    k2) k2_mode;;
  esac
}

# start_background is useful when launching from udev rule
start_background() {
  (
  # The sleep is needed to work with udev
  sleep 1

  # These variables are needed to work with udev
  export XAUTHORITY=/home/pez/.Xauthority
  export DISPLAY=:0

  set_mode $@
  ) </dev/null >/dev/null 2>/dev/null &
}

# start_background is useful when launching from command line
start_foreground() {
  set_mode $@
}

if [ -z "${DISPLAY}" ]; then
  start_background $@
else
  start_foreground $@
fi

exit 0
