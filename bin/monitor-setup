#!/bin/bash

layout="${1}"
default_layout=laptop

auto_detect_layout() {
  local result=${default_layout}
  local monitors=$( xrandr )

  local dp1_1=$( xrandr | grep "DP1-1 connected" &>/dev/null && echo 1 )
  local dp1_2=$( xrandr | grep "DP1-2 connected" &>/dev/null && echo 1 )
  local hdmi2=$( xrandr | grep "HDMI2 connected" &>/dev/null && echo 1 )

  echo "dp1_1=${dp1_1} dp1_2=${dp1_2} hdmi2=${hdmi2}"

  if [ $dp1_1 ] && [ $dp1_2 ]; then
    result=home
  elif [ $hdmi2 ]; then
    result=ext-right
  fi

  echo ${result}
}

if [ "${layout}" == "manual" ]; then
  arandr
  exit 0
fi

if [ "${layout}" == "auto" ]; then
  layout=$( auto_detect_layout )
fi

autorandr --load "${layout}" 2>/dev/null

# Launch in background
(
# After monitor setup, polybar must be reloaded
~/.dotfiles/wm/bin/polybar-launcher

# And wallpaper should be reloaded to fit
~/.dotfiles/wm/bin/change-background load

# If we need to setup the monitor, maybe we have a keyboard to set up too
~/.dotfiles/bin/keyboard-setup
) &>/dev/null </dev/null &
