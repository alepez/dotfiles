#!/bin/bash
#
# Run something on file (or directory) change.
#
# Example
#     watch_do myprogram.hs 'ghc myprogram.hs -o myprogram && ./myprogram'
#

while true; do
  echo ================================================================================
  echo
  ( bash -c "${2}" ) 2>&1 &
  PID=$!
  echo PID: ${PID}
  echo
  echo ================================================================================
  echo Waiting...
  inotifywait \
    --exclude '@neomake' \
    --exclude 'target' \
    --recursive --event modify "${1}"
  echo Change detected
  sleep 0.250
  kill ${PID}
  clear
done
