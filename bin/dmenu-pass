#!/usr/bin/env bash

pass_to_clipboard() {
  local password="${1}"
  local tmpfile=$(mktemp)
  pass show -c1 "$password" > $tmpfile
  notify-send -u low "$( cat $tmpfile )"
  rm $tmpfile
}

pass_to_passmumbler() {
  local password="${1}"
  local tmpfile=$(mktemp)
  pass show "$password" > $tmpfile
  local p="$( head -1 $tmpfile )" 
  local u="$( grep '^username:' $tmpfile | head -1 | awk '{ print $2 }' )"
  passmumbler -p "${p}" -u "${u}"
  rm $tmpfile
}

main() {
  shopt -s nullglob globstar

  dmenu="$( realpath ~/.dotfiles/bin/dmenu )"

  prefix=${PASSWORD_STORE_DIR-~/.password-store}
  password_files=( "$prefix"/**/*.gpg )
  password_files=( "${password_files[@]#"$prefix"/}" )
  password_files=( "${password_files[@]%.gpg}" )

  password=$(printf '%s\n' "${password_files[@]}" | "${dmenu}" -dmenu -p "Password" "$@")

  [[ -n $password ]] || exit

  if which passmumbler &>/dev/null; then
    pass_to_passmumbler "${password}"
  else
    pass_to_clipboard "${password}"
  fi
}

main $@
