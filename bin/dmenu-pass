#!/usr/bin/env bash

pass_to_clipboard() {
  local password="${1}"
  local tmpfile=$(mktemp)
  pass show -c1 "$password" > $tmpfile
  notify-send -u low "$( cat $tmpfile )"
  rm $tmpfile
}

pass_to_passmumbler() {
  pass show "${1}" | passmumbler --stdin
}

list_passwords() {
  shopt -s nullglob globstar

  local prefix=${PASSWORD_STORE_DIR-~/.password-store}

  local password_files=( "${prefix}"/passwords/**/*.gpg )
  password_files=( "${password_files[@]#"${prefix}"/}" )
  password_files=( "${password_files[@]%.gpg}" )

  printf '%s\n' "${password_files[@]}" ^ \
    | sed 's/^passwords\///'
}

select_password() {
  local dmenu="$( realpath ~/.dotfiles/bin/dmenu )"

  password=$( list_passwords | "${dmenu}" -dmenu -p "Password" "$@" )
  echo "passwords/${password}"
}

main() {
  local password=$( select_password )

  [[ -n $password ]] || exit

  if which passmumbler &>/dev/null; then
    pass_to_passmumbler "${password}"
  else
    pass_to_clipboard "${password}"
  fi
}

main $@
