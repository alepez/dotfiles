#!/usr/bin/env bash

# Manage zfs snapshots

list_snapshots() {
  zfs list -d 1 -t snapshot zroot/${1}
}

make_snapshot() {
  t=$(date +%Y-%m-%d-%H-%M-%S --utc | tr -d \\n)
  sudo zfs snapshot zroot/${1}@${t}
}

make_snapshots() {
  for i in ROOT/default data/home data/sdk; do
    make_snapshot ${i}
    list_snapshots ${i}
  done
}

list_all_snapshots() {
  for i in ROOT/default data/home data/sdk; do
    list_snapshots ${i}
  done
}

destroy() {
  sudo zfs destroy ${1}
}

destroy_many() {
  for i in $@; do
    sudo zfs destroy ${i}
  done
}

list_all_snapshots_for_destroy() {
  list_all_snapshots \
    | grep zroot \
    | awk '{ print $1 }' \
    | tr '@' ' ' \
    | sort -k 2 \
    | tr ' ' '@'
}

destroy_from_list() {
  while read line; do
    echo $line
    destroy $line
  done
}

die() {
  echo "$1"
  exit 1
}

main() {
  local subcommand=$1
  shift

  case $subcommand in
    list) list_all_snapshots;;
    list_for_destroy) list_all_snapshots_for_destroy;;
    destroy_from_list) destroy_from_list;;
    destroy) destroy $@;;
    "") make_snapshots;;
    *) die "invalid command";;
  esac

}

main $@
